<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡ Ø´Ø®ØµÛŒ â€“ Ù†Ø³Ø®Ù‡Ù” Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#2156a8">
  <meta name="description" content="Ù†Ø³Ø®Ù‡Ù” Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡ Ø´Ø®ØµÛŒ: Ú†Ù†Ø¯ Ø­Ø³Ø§Ø¨ØŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡ØŒ ØªØ±Ø§Ú©Ù†Ø´ ØªÚ©Ø±Ø§Ø±Ø´ÙˆÙ†Ø¯Ù‡ØŒ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ØŒ ÙÛŒÙ„ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡ØŒ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„/JSONØŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒØŒ Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡ØŒ PWA Ø¢ÙÙ„Ø§ÛŒÙ†.">
  <link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128' viewBox='0 0 24 24'%3E%3Cpath fill='%232156a8' d='M3 7a2 2 0 0 1 2-2h12a4 4 0 0 1 4 4v6a3 3 0 0 1-3 3H5a2 2 0 0 1-2-2z'/%3E%3Cpath fill='%23fff' d='M17 9h3v6h-3a3 3 0 1 1 0-6'/%3E%3C/svg%3E"/>

  <!-- Persian font -->
  <link href="https://cdn.fontcdn.ir/Font/Persian/Sahel/Sahel.css" rel="stylesheet">

  <!-- Chart.js & SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --main: #2156a8;
      --accent: #16a34a;
      --danger: #ef4444;
      --warn: #f59e0b;
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --ring: #c7d7ff;
    }
    :root.theme-dark {
      --main: #6aa0ff;
      --accent: #22c55e;
      --danger: #ff6b6b;
      --warn: #ffd166;
      --bg: #0b1220;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9aa4b2;
      --ring: #1f2a44;
    }
    :root.theme-green {
      --main: #15803d;
      --accent: #22c55e;
      --danger: #dc2626;
      --warn: #d97706;
      --bg: #ecfdf5;
      --card: #ffffff;
      --text: #1f2a44;
      --muted: #6b7280;
      --ring: #a7f3d0;
    }
    :root.theme-purple {
      --main: #7e22ce;
      --accent: #a855f7;
      --danger: #dc2626;
      --warn: #d97706;
      --bg: #f5f3ff;
      --card: #ffffff;
      --text: #1f2a44;
      --muted: #6b7280;
      --ring: #ddd6fe;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Sahel', Tahoma, Arial, sans-serif; }
    a { color: var(--main); text-decoration: none; }
    .container { max-width: 1200px; margin: 0 auto; padding: 14px; display: flex; flex-direction: column; gap: 14px; min-height: 100vh; }
    .topbar { display: flex; align-items: center; justify-content: space-between; gap: 8px; position: relative; }
    .title { display: flex; align-items: center; gap: 10px; }
    .title h1 { margin: 0; font-size: 20px; color: var(--main); }
    .chip { background: var(--card); border: 1px dashed var(--ring); color: var(--muted); padding: 6px 10px; border-radius: 999px; font-size: 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .btn { background: var(--main); color: #fff; border: 0; border-radius: 10px; padding: 8px 12px; cursor: pointer; box-shadow: 0 6px 16px rgba(33,86,168,.14); font-weight: 700; transition: transform 0.2s, box-shadow 0.2s; }
    .btn:active { transform: scale(0.95); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .btn-ghost { background: transparent; border: 1px solid var(--ring); color: var(--main); border-radius: 10px; padding: 6px 10px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .btn-ghost:active { transform: scale(0.95); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .btn-danger { background: var(--danger); }
    .btn-success { background: var(--accent); }
    .card { background: var(--card); border: 1px solid var(--ring); border-radius: 14px; box-shadow: 0 4px 22px rgba(0,0,0,.05); padding: 12px; transition: transform 0.3s ease, opacity 0.3s ease; }
    .card.hidden { opacity: 0; transform: scale(0.98); }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .stat { text-align: center; }
    .stat strong { display: block; font-size: 22px; }
    .stat label { color: var(--muted); font-size: 13px; }
    .form { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; align-items: end; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-size: 12px; color: var(--muted); }
    .input, select, textarea { background: var(--bg); color: var(--text); border: 1px solid var(--ring); border-radius: 10px; padding: 9px 10px; outline: none; font-family: inherit; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; min-width: 880px; }
    th, td { padding: 9px; border-bottom: 1px solid var(--ring); text-align: center; }
    thead th { position: sticky; top: 0; background: var(--card); z-index: 1; cursor: pointer; }
    tbody tr:nth-child(odd) { background: rgba(0,0,0,.02); }
    tbody tr { animation: fadeIn 0.3s ease-out; }
    .actions button { background: transparent; color: var(--main); border: 0; box-shadow: none; padding: 0 6px; font-size: 18px; cursor: pointer; }
    .danger { color: var(--danger); }
    .chart-box { display: flex; align-items: center; justify-content: center; height: 260px; }
    .budget-list { display: grid; gap: 10px; }
    .budget-item { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .progress { height: 10px; border-radius: 999px; background: var(--ring); width: 100%; overflow: hidden; }
    .progress>span { display: block; height: 100%; }
    .ok>span { background: var(--accent); } .warn>span { background: var(--warn); } .bad>span { background: var(--danger); }
    footer { margin-top: auto; text-align: center; color: var(--muted); font-size: 13px; }
    .pill { padding: 4px 10px; border-radius: 999px; border: 1px solid var(--ring); background: var(--card); color: var(--muted); font-size: 12px; }
    .sep { height: 1px; background: var(--ring); margin: 10px 0; }
    select#category option { padding-right: 25px; }
    select#category option::before { content: attr(data-icon); margin-left: 5px; }
    .table-scroll { width: 100%; overflow-x: auto; overflow-y: auto; max-height: 360px; }
    .table-scroll table { min-width: 700px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 980px) { .grid { grid-template-columns: repeat(6, 1fr); } .form { grid-template-columns: repeat(6, 1fr); } }
    @media (max-width: 560px) {
      .grid, .form { grid-template-columns: repeat(2, 1fr); }
      .title h1 { font-size: 17px; }
      .table-scroll { display: none; }
      .card-list { display: flex; flex-direction: column; gap: 10px; }
      .card-item { background: var(--card); border: 1px solid var(--ring); border-radius: 10px; padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px; }
      .card-item label { color: var(--muted); font-size: 12px; }
      .card-item strong { font-weight: 700; }
      .card-item .actions { grid-column: span 2; text-align: left; }
      .table-scroll table { min-width: 600px; font-size: 13px; }
      th, td { padding: 6px; }
      .form { grid-template-columns: repeat(1, 1fr) !important; }
      .field { grid-column: span 12 !important; }
      .row { flex-direction: column; align-items: stretch; }
    }

    /* Notifications panel */
    .notif-btn { position: relative; }
    #notifBtn { position: relative; }
    #notifCount { position: absolute; top: -6px; left: -6px; background: var(--danger); color: white; border-radius: 999px; padding: 2px 6px; font-size: 11px; }
    #notifPanel { position: absolute; right: 8px; top: 48px; width: 320px; max-height: 420px; overflow-y: auto; background: var(--card); border: 1px solid var(--ring); box-shadow: 0 6px 22px rgba(0,0,0,.12); border-radius: 10px; padding: 10px; display: none; z-index: 9999; }
    #notifPanel .nitem { border-radius: 8px; padding: 8px; margin-bottom: 8px; border: 1px solid var(--ring); }
    #notifPanel .nitem.warn { border-left: 4px solid var(--warn); }
    #notifPanel .nitem.bad { border-left: 4px solid var(--danger); }
    #notifPanel .nitem.ok { border-left: 4px solid var(--accent); }
    #notifPanel .nitem small { display:block; color:var(--muted); margin-top:6px; font-size:12px; }
    #notifClose { display:block; text-align:center; margin-top:6px; }
  </style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="title">
      <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡ Ø´Ø®ØµÛŒ â€“ Ù†Ø³Ø®Ù‡Ù” Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</h1>
    </div>
    <div class="row">
      <button id="darkToggle" class="btn-ghost" title="ØªØºÛŒÛŒØ± ØªÙ… (T)">ğŸ¨</button>
      <button id="undoBtn" class="btn-ghost" title="Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ± (Ctrl+Z)">Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†</button>
      <button id="backupBtn" class="btn-ghost" title="Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ JSON (Ctrl+S)">Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
      <label class="btn-ghost" title="Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² JSON">Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ<input id="restoreInput" type="file" accept="application/json" style="display:none"></label>

      <!-- Notifications button -->
      <div style="position:relative" class="notif-btn">
        <button id="notifBtn" class="btn-ghost" title="Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§">ğŸ”” <span id="notifCount" style="display:none">0</span></button>
        <div id="notifPanel" aria-hidden="true">
          <div id="notifList"></div>
          <button id="notifClose" class="btn-ghost">Ø¨Ø³ØªÙ†</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
  <div class="grid">
    <div class="card stat" style="grid-column: span 3"><strong id="balance">Û°</strong><label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø®Ø§Ù„Øµ</label></div>
    <div class="card stat" style="grid-column: span 3"><strong id="sumIncome">Û°</strong><label>Ø¬Ù…Ø¹ Ø¯Ø±Ø¢Ù…Ø¯</label></div>
    <div class="card stat" style="grid-column: span 3"><strong id="sumExpense">Û°</strong><label>Ø¬Ù…Ø¹ Ù‡Ø²ÛŒÙ†Ù‡</label></div>
    <div class="card stat" style="grid-column: span 3"><strong id="sumSaving">Û°</strong><label>Ø¬Ù…Ø¹ Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²</label></div>
  </div>

  <!-- ÙØ±Ù… Ø«Ø¨Øª -->
  <div class="card">
    <form id="txForm" class="form" autocomplete="off">
      <div class="field" style="grid-column: span 4">
        <label>Ø´Ø±Ø­</label>
        <input id="desc" class="input" placeholder="Ø­Ù‚ÙˆÙ‚ØŒ Ø®Ø±ÛŒØ¯ Ù…ÛŒÙˆÙ‡ØŒ Ù‚Ø¨Ø¶..." required>
      </div>
      <div class="field" style="grid-column: span 2">
        <label>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="amount" class="input" type="number" min="1" step="1" required>
      </div>
      <div class="field" style="grid-column: span 2">
        <label>Ø¯Ø³ØªÙ‡</label>
        <select id="category">
          <option value="income" data-icon="ğŸ’°">Ø¯Ø±Ø¢Ù…Ø¯</option>
          <option value="expense" data-icon="ğŸ›’">Ù‡Ø²ÛŒÙ†Ù‡</option>
          <option value="saving" data-icon="ğŸ¦">Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²</option>
        </select>
      </div>
      <div class="field" style="grid-column: span 2">
        <label>Ø²ÛŒØ±Ø¯Ø³ØªÙ‡</label>
        <input id="subcat" class="input" placeholder="Ø®ÙˆØ±Ø§Ú©ÛŒØŒ Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„...">
      </div>
      <div class="field" style="grid-column: span 2">
        <label>Ø­Ø³Ø§Ø¨/Ú©ÛŒÙ Ù¾ÙˆÙ„</label>
        <select id="wallet"></select>
      </div>
      <div class="field" style="grid-column: span 2">
        <label>ØªØ§Ø±ÛŒØ®</label>
        <input id="date" class="input" type="date">
      </div>
      <div class="field" style="grid-column: span 2">
        <label>ØªÚ©Ø±Ø§Ø±Ø´ÙˆÙ†Ø¯Ù‡ØŸ</label>
        <select id="recurring">
          <option value="no">Ø®ÛŒØ±</option>
          <option value="monthly">Ù…Ø§Ù‡Ø§Ù†Ù‡</option>
          <option value="weekly">Ù‡ÙØªÚ¯ÛŒ</option>
          <option value="daily">Ø±ÙˆØ²Ø§Ù†Ù‡</option>
        </select>
      </div>
      <div class="row" style="grid-column: span 12; justify-content: space-between">
        <div class="row">
          <span class="pill">Ù…ÛŒØ§Ù†Ø¨Ø±Ù‡Ø§: N=Ø«Ø¨Øª Ø¬Ø¯ÛŒØ¯ØŒ /=Ø¬Ø³ØªØ¬ÙˆØŒ Ctrl+S=Ù¾Ø´ØªÛŒØ¨Ø§Ù†ØŒ Ctrl+Z=Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†ØŒ T=ØªÛŒØ±Ù‡</span>
        </div>
        <div class="row">
          <button id="submitBtn" class="btn" type="submit">Ø§ÙØ²ÙˆØ¯Ù†</button>
          <button id="cancelEdit" class="btn-ghost" type="button" hidden>Ù„ØºÙˆ</button>
        </div>
      </div>
    </form>
  </div>

  <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ Ùˆ Ø§Ø¨Ø²Ø§Ø± -->
  <div class="card row" style="justify-content:space-between">
    <div class="row">
      <label>Ø§Ø² <input class="input" type="date" id="fStart"></label>
      <label>ØªØ§ <input class="input" type="date" id="fEnd"></label>
      <label>Ø¯Ø³ØªÙ‡
        <select id="fCat">
          <option value="">Ù‡Ù…Ù‡</option>
          <option value="income">Ø¯Ø±Ø¢Ù…Ø¯</option>
          <option value="expense">Ù‡Ø²ÛŒÙ†Ù‡</option>
          <option value="saving">Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²</option>
        </select>
      </label>
      <label>Ø­Ø³Ø§Ø¨
        <select id="fWallet"></select>
      </label>
      <input id="fSearch" class="input" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø´Ø±Ø­/Ø²ÛŒØ±Ø¯Ø³ØªÙ‡">
    </div>
    <div class="row">
      <button id="resetFilters" class="btn-ghost">Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù†</button>
      <button id="exportJson" class="btn-ghost">Ø®Ø±ÙˆØ¬ÛŒ JSON</button>
      <button id="exportExcel" class="btn-ghost">Ø§Ú©Ø³Ù„</button>
      <label class="btn-ghost">ÙˆØ±ÙˆØ¯ CSV<input id="importCsv" type="file" accept=".csv,text/csv" style="display:none"></label>
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ -->
  <div class="card table-wrapper">
    <div class="table-scroll">
      <table id="table">
        <thead>
          <tr>
            <th data-sort="date">ØªØ§Ø±ÛŒØ®</th>
            <th data-sort="category">Ø¯Ø³ØªÙ‡</th>
            <th data-sort="subcat">Ø²ÛŒØ±Ø¯Ø³ØªÙ‡</th>
            <th data-sort="desc">Ø´Ø±Ø­</th>
            <th data-sort="amount">Ù…Ø¨Ù„Øº</th>
            <th data-sort="wallet">Ø­Ø³Ø§Ø¨</th>
            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="card-list" style="display: none;"></div>
  </div>

  <!-- Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ + Ø¨ÙˆØ¯Ø¬Ù‡ -->
  <div class="grid">
    <div class="card" style="grid-column: span 6">
      <h3 style="margin:6px 0;color:var(--main)">Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø±Ø¢Ù…Ø¯/Ù‡Ø²ÛŒÙ†Ù‡/Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²</h3>
      <div class="chart-box"><canvas id="chartMain"></canvas></div>
      <div class="sep"></div>
      <h3 style="margin:6px 0;color:var(--main)">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø²ÛŒØ±Ø¯Ø³ØªÙ‡</h3>
      <div class="chart-box"><canvas id="chartMonth"></canvas></div>
    </div>
    <div class="card" style="grid-column: span 6">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:6px 0;color:var(--main)">Ø¨ÙˆØ¯Ø¬Ù‡Ù” Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</h3>
        <div class="row">
          <input id="budgetSubcat" class="input" placeholder="Ø²ÛŒØ±Ø¯Ø³ØªÙ‡ (Ù…Ø«Ù„Ø§Ù‹: Ø®ÙˆØ±Ø§Ú©ÛŒ)">
          <input id="budgetAmount" class="input" type="number" min="0" step="1" placeholder="Ø¨ÙˆØ¯Ø¬Ù‡ (ØªÙˆÙ…Ø§Ù†)">
          <button id="addBudget" class="btn">Ø«Ø¨Øª Ø¨ÙˆØ¯Ø¬Ù‡</button>
        </div>
      </div>
      <div id="budgetList" class="budget-list"></div>
      <div class="sep"></div>
      <h4 style="margin:6px 0;color:var(--main)">Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§</h4>
      <div class="row">
        <input id="newWallet" class="input" placeholder="Ù†Ø§Ù… Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯">
        <button id="addWallet" class="btn-ghost">Ø§ÙØ²ÙˆØ¯Ù† Ø­Ø³Ø§Ø¨</button>
      </div>
      <div id="walletList" class="row" style="margin-top:8px;flex-wrap:wrap"></div>
    </div>
  </div>

  <!-- ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±Ø´ÙˆÙ†Ø¯Ù‡ -->
  <div class="card">
    <h3 style="margin:6px 0;color:var(--main)">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±Ø´ÙˆÙ†Ø¯Ù‡</h3>
    <div style="overflow:auto">
      <table style="min-width:760px">
        <thead><tr><th>Ø´Ø±Ø­</th><th>Ù…Ø¨Ù„Øº</th><th>Ø¯Ø³ØªÙ‡</th><th>Ø²ÛŒØ±Ø¯Ø³ØªÙ‡</th><th>Ø­Ø³Ø§Ø¨</th><th>ØªÙ†Ø§ÙˆØ¨</th><th>ÙØ¹Ø§Ù„</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
        <tbody id="rcBody"></tbody>
      </table>
    </div>
  </div>

  <footer>Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† Ø¹Ù„ÛŒØ§Ø¦ÛŒ â€” Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§: Ú†Ù†Ø¯ Ø­Ø³Ø§Ø¨ØŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø§Ù‡Ø§Ù†Ù‡ØŒ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±Ø´ÙˆÙ†Ø¯Ù‡ØŒ Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡ØŒ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ØŒ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„/JSONØŒ Undo Ùˆ PWA.</footer>
</div>

<!-- Service Worker source -->
<script id="swSrc" type="text/plain">
const CACHE='pfm-pro-v2';
const ASSETS=['.'];
self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()))});
self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)))});
</script>

<script>
// ======== State & Storage ========
const state = {
  version: 2,
  tx: [],
  wallets: ['Ø§ØµÙ„ÛŒ'],
  budgets: {},
  recurring: [],
  settings: { dark: false, theme: 'default', currency: 'ØªÙˆÙ…Ø§Ù†' },
  sort: { key: 'date', dir: 'desc' },
  editId: null
};
const storeKey = 'pfm_pro_best_v1';
const undoStack = [];

function pushUndo() { undoStack.push(JSON.stringify(state)); if (undoStack.length > 25) undoStack.shift(); }
function undo() { if (!undoStack.length) return; const raw = undoStack.pop(); try { Object.assign(state, JSON.parse(raw)); save(); applyAll(); } catch {} }

function save() { localStorage.setItem(storeKey, JSON.stringify(state)); }
function load() {
  const raw = localStorage.getItem(storeKey); if (!raw) return;
  try { const s = JSON.parse(raw); Object.assign(state, s); } catch {}
}

// ======== Utils ========
const $ = s => document.querySelector(s), $$ = s => Array.from(document.querySelectorAll(s));
const els = {
  balance: $('#balance'), sumIncome: $('#sumIncome'), sumExpense: $('#sumExpense'), sumSaving: $('#sumSaving'),
  form: $('#txForm'), desc: $('#desc'), amount: $('#amount'), category: $('#category'), subcat: $('#subcat'),
  wallet: $('#wallet'), date: $('#date'), recurring: $('#recurring'), submitBtn: $('#submitBtn'), cancelEdit: $('#cancelEdit'),
  fStart: $('#fStart'), fEnd: $('#fEnd'), fCat: $('#fCat'), fWallet: $('#fWallet'), fSearch: $('#fSearch'),
  resetFilters: $('#resetFilters'), exportJson: $('#exportJson'), exportExcel: $('#exportExcel'), importCsv: $('#importCsv'),
  tbody: $('#tbody'), table: $('#table'),
  chartMain: $('#chartMain'), chartMonth: $('#chartMonth'),
  budgetSubcat: $('#budgetSubcat'), budgetAmount: $('#budgetAmount'), addBudget: $('#addBudget'), budgetList: $('#budgetList'),
  newWallet: $('#newWallet'), addWallet: $('#addWallet'), walletList: $('#walletList'),
  rcBody: $('#rcBody'),
  darkToggle: $('#darkToggle'), backupBtn: $('#backupBtn'), restoreInput: $('#restoreInput'),
  undoBtn: $('#undoBtn'),
  notifBtn: $('#notifBtn'), notifPanel: $('#notifPanel'), notifList: $('#notifList'), notifCount: $('#notifCount'), notifClose: $('#notifClose')
};
const fmt = n => (Number(n) || 0).toLocaleString('fa-IR');
const todayStr = () => new Date().toISOString().slice(0, 10);
const monthKey = (dStr) => (dStr || todayStr()).slice(0, 7);
function escapeHtml(s) { return (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }
const categoryIcons = { income: 'ğŸ’°', expense: 'ğŸ›’', saving: 'ğŸ¦' };
function categoryLabel(c) { return `${categoryIcons[c] || ''} ${c === 'income' ? 'Ø¯Ø±Ø¢Ù…Ø¯' : c === 'expense' ? 'Ù‡Ø²ÛŒÙ†Ù‡' : c === 'saving' ? 'Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²' : c}`; }

// ======== PWA Register ========
(function registerPWA() {
  if (!('serviceWorker' in navigator)) return;
  const blob = new Blob([document.getElementById('swSrc').textContent], { type: 'text/javascript' });
  const url = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url, { scope: './' });
  const manifest = { name: 'Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡ Ø´Ø®ØµÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ', short_name: 'Ù‡Ø²ÛŒÙ†Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ', start_url: './', display: 'standalone', background_color: '#2156a8', theme_color: '#2156a8', dir: 'rtl', lang: 'fa' };
  const mblob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  const murl = URL.createObjectURL(mblob);
  const link = document.createElement('link'); link.rel = 'manifest'; link.href = murl; document.head.appendChild(link);
})();

// ======== Initialization ========
let chartMainObj = null, chartMonthObj = null;
let inBrowserNotificationPermissionRequested = false;
let currentNotifications = []; // ephemeral notifications list shown in panel

function ensureDateDefault() { if (!els.date.value) els.date.value = todayStr(); }
function ensureWallet(name) { if (!name) return 'Ø§ØµÙ„ÛŒ'; if (!state.wallets.includes(name)) state.wallets.push(name); return name; }
function renderWallets() {
  const opts = state.wallets.map(w => `<option value="${escapeHtml(w)}">${escapeHtml(w)}</option>`).join('');
  els.wallet.innerHTML = opts;
  els.fWallet.innerHTML = '<option value="">Ù‡Ù…Ù‡</option>' + opts;
  els.walletList.innerHTML = '';
  state.wallets.forEach(w => {
    const span = document.createElement('span'); span.className = 'pill'; span.textContent = w + ' ';
    const del = document.createElement('button'); del.className = 'actions danger'; del.textContent = 'âœ–'; del.title = 'Ø­Ø°Ù Ø­Ø³Ø§Ø¨';
    del.onclick = () => {
      if (state.tx.some(t => t.wallet === w)) { alert('Ø§Ø¨ØªØ¯Ø§ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø±Ø§ Ø­Ø°Ù ÛŒØ§ Ù…Ù†ØªÙ‚Ù„ Ú©Ù†ÛŒØ¯.'); return; }
      pushUndo();
      state.wallets = state.wallets.filter(x => x !== w);
      if (!state.wallets.length) state.wallets = ['Ø§ØµÙ„ÛŒ'];
      save(); renderWallets(); applyAll();
    };
    span.appendChild(del);
    els.walletList.appendChild(span);
  });
}

function applyTheme() {
  document.documentElement.classList.remove('theme-dark', 'theme-green', 'theme-purple');
  if (state.settings.theme !== 'default') {
    document.documentElement.classList.add(`theme-${state.settings.theme}`);
  }
}
els.darkToggle.addEventListener('click', () => {
  state.settings.theme = state.settings.theme === 'default' ? 'dark' : state.settings.theme === 'dark' ? 'green' : state.settings.theme === 'green' ? 'purple' : 'default';
  save();
  applyTheme();
});

// ======== Recurring ========
function nextDate(ds, freq) {
  const d = new Date(ds);
  if (freq === 'daily') { d.setDate(d.getDate() + 1); }
  else if (freq === 'weekly') { d.setDate(d.getDate() + 7); }
  else if (freq === 'monthly') { d.setMonth(d.getMonth() + 1); }
  return d.toISOString().slice(0, 10);
}
function applyRecurringUpToToday() {
  const today = todayStr();
  state.recurring.forEach(rc => {
    if (rc.active === false) return;
    let last = rc.lastApplied || rc.startDate;
    if (!last) return;
    let nd = nextDate(last, rc.frequency);
    while (nd <= today) {
      state.tx.push({ id: uid(), desc: rc.desc, amount: rc.amount, category: rc.category, subcat: rc.subcat || '', wallet: rc.wallet || 'Ø§ØµÙ„ÛŒ', date: nd });
      last = nd; nd = nextDate(last, rc.frequency);
    }
    rc.lastApplied = last;
  });
}
function renderRecurring() {
  els.rcBody.innerHTML = '';
  state.recurring.forEach(rc => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(rc.desc || '')}</td><td>${fmt(rc.amount)}</td><td>${categoryLabel(rc.category)}</td>
    <td>${escapeHtml(rc.subcat || '')}</td><td>${escapeHtml(rc.wallet || 'Ø§ØµÙ„ÛŒ')}</td><td>${rc.frequency}</td>
    <td><input type="checkbox" ${rc.active !== false ? 'checked' : ''} /></td>
    <td class="actions"><button title="ÙˆÛŒØ±Ø§ÛŒØ´" class="edit">âœï¸</button><button title="Ø­Ø°Ù" class="danger">ğŸ—‘ï¸</button></td>`;
    tr.querySelector('.edit').onclick = () => {
      els.desc.value = rc.desc;
      els.amount.value = rc.amount;
      els.category.value = rc.category;
      els.subcat.value = rc.subcat || '';
      els.wallet.value = ensureWallet(rc.wallet || 'Ø§ØµÙ„ÛŒ');
      els.date.value = rc.startDate || todayStr();
      els.recurring.value = rc.frequency;
      state.editId = rc.id;
      els.submitBtn.textContent = 'Ø«Ø¨Øª ÙˆÛŒØ±Ø§ÛŒØ´';
      els.cancelEdit.hidden = false;
      els.desc.focus();
    };
    const chk = tr.querySelector('input'); chk.onchange = () => { rc.active = chk.checked; save(); };
    tr.querySelector('.danger').onclick = () => {
      pushUndo();
      state.recurring = state.recurring.filter(x => x !== rc); save(); renderRecurring();
    };
    els.rcBody.appendChild(tr);
  });
}

// ======== Helpers ========
function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
function calcStats(list) {
  let income = 0, expense = 0, saving = 0;
  for (const t of list) {
    const a = Number(t.amount) || 0;
    if (t.category === 'income') income += a; else if (t.category === 'expense') expense += a; else if (t.category === 'saving') saving += a;
  }
  return { income, expense, saving, balance: income - expense - saving };
}
function filtered() {
  const s = els.fStart.value, e = els.fEnd.value, cat = els.fCat.value, w = els.fWallet.value, q = (els.fSearch.value || '').trim().toLowerCase();
  let list = state.tx.filter(t => {
    if (s && t.date < s) return false;
    if (e && t.date > e) return false;
    if (cat && t.category !== cat) return false;
    if (w && t.wallet !== w) return false;
    if (q && !((t.desc || '').toLowerCase().includes(q) || (t.subcat || '').toLowerCase().includes(q))) return false;
    return true;
  });
  const { key, dir } = state.sort;
  list.sort((a, b) => {
    const va = a[key] ?? ''; const vb = b[key] ?? '';
    if (key === 'amount') return (Number(va) - Number(vb)) * (dir === 'asc' ? 1 : -1);
    return (va > vb ? 1 : va < vb ? -1 : 0) * (dir === 'asc' ? 1 : -1);
  });
  return list;
}
function renderTable(list) {
  els.tbody.innerHTML = '';
  const isMobile = window.innerWidth <= 560;
  if (isMobile) {
    const cardList = $('.card-list');
    cardList.innerHTML = '';
    cardList.style.display = 'flex';
    if (!list.length) {
      const div = document.createElement('div');
      div.textContent = 'Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
      cardList.appendChild(div);
    } else {
      list.forEach((t, i) => {
        const card = document.createElement('div');
        card.className = 'card-item';
        card.style.animationDelay = `${i * 0.05}s`;
        card.innerHTML = `
          <label>ØªØ§Ø±ÛŒØ®</label><span>${t.date}</span>
          <label>Ø¯Ø³ØªÙ‡</label><span>${categoryLabel(t.category)}</span>
          <label>Ø²ÛŒØ±Ø¯Ø³ØªÙ‡</label><span>${escapeHtml(t.subcat || '')}</span>
          <label>Ø´Ø±Ø­</label><span>${escapeHtml(t.desc || '')}</span>
          <label>Ù…Ø¨Ù„Øº</label><strong>${fmt(t.amount)} ØªÙˆÙ…Ø§Ù†</strong>
          <label>Ø­Ø³Ø§Ø¨</label><span>${escapeHtml(t.wallet || 'Ø§ØµÙ„ÛŒ')}</span>
          <div class="actions">
            <button title="ÙˆÛŒØ±Ø§ÛŒØ´" data-edit>âœï¸</button>
            <button title="Ø­Ø°Ù" class="danger" data-del>ğŸ—‘ï¸</button>
          </div>`;
        card.querySelector('[data-edit]').onclick = () => editTx(t.id);
        card.querySelector('[data-del]').onclick = () => delTx(t.id);
        cardList.appendChild(card);
      });
    }
  } else {
    $('.card-list').style.display = 'none';
    if (!list.length) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 7;
      td.textContent = 'Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
      tr.appendChild(td);
      els.tbody.appendChild(tr);
      return;
    }
    list.forEach((t, i) => {
      const tr = document.createElement('tr');
      tr.style.animationDelay = `${i * 0.05}s`;
      tr.innerHTML = `
        <td>${t.date}</td>
        <td>${categoryLabel(t.category)}</td>
        <td>${escapeHtml(t.subcat || '')}</td>
        <td>${escapeHtml(t.desc || '')}</td>
        <td style="font-weight:700">${fmt(t.amount)}</td>
        <td>${escapeHtml(t.wallet || 'Ø§ØµÙ„ÛŒ')}</td>
        <td class="actions">
          <button title="ÙˆÛŒØ±Ø§ÛŒØ´" data-edit>âœï¸</button>
          <button title="Ø­Ø°Ù" class="danger" data-del>ğŸ—‘ï¸</button>
        </td>`;
      tr.querySelector('[data-edit]').onclick = () => editTx(t.id);
      tr.querySelector('[data-del]').onclick = () => delTx(t.id);
      els.tbody.appendChild(tr);
    });
  }
}

// ======== Charts ========
function drawMainChart(list) {
  const st = calcStats(list);
  const ctx = els.chartMain.getContext('2d');
  if (chartMainObj) chartMainObj.destroy();
  chartMainObj = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Ø¯Ø±Ø¢Ù…Ø¯', 'Ù‡Ø²ÛŒÙ†Ù‡', 'Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²'],
      datasets: [{ data: [st.income, st.expense, st.saving], backgroundColor: ['rgba(34,197,94,.85)', 'rgba(239,68,68,.85)', 'rgba(33,86,168,.8)'], borderWidth: 2 }]
    },
    options: { plugins: { legend: { position: 'bottom' } } }
  });
}
function drawMonthChart() {
  const key = monthKey(); const pref = key + '-';
  const map = {};
  state.tx.forEach(t => {
    if (t.category === 'expense' && t.date.startsWith(pref)) {
      map[t.subcat || 'Ø³Ø§ÛŒØ±'] = (map[t.subcat || 'Ø³Ø§ÛŒØ±'] || 0) + (Number(t.amount) || 0);
    }
  });
  const labels = Object.keys(map);
  const values = labels.map(k => map[k]);
  const ctx = els.chartMonth.getContext('2d');
  if (chartMonthObj) chartMonthObj.destroy();
  chartMonthObj = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Ù‡Ø²ÛŒÙ†Ù‡Ù” Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ', data: values }] },
    options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });
}

// ======== Budgets ========
function setBudget(subcat, amount) {
  const key = monthKey();
  if (!state.budgets[key]) state.budgets[key] = {};
  if (!subcat) return;
  state.budgets[key][subcat] = Number(amount) || 0;
  save(); renderBudgets();
}
function getSpentThisMonth(subcat) {
  const k = monthKey(); const pref = k + '-';
  return state.tx.filter(t => t.category === 'expense' && (t.subcat || '') === subcat && t.date.startsWith(pref)).reduce((s, t) => s + (Number(t.amount) || 0), 0);
}
function renderBudgets() {
  const key = monthKey(); const map = state.budgets[key] || {};
  els.budgetList.innerHTML = '';
  const budgetAlerts = []; // collect alerts to push to notifications panel
  Object.keys(map).forEach(sub => {
    const limit = Number(map[sub]) || 0;
    const spent = getSpentThisMonth(sub);
    const ratio = limit > 0 ? spent / limit : 0;
    const pct = limit > 0 ? Math.round(ratio * 100) : 0;
    const widthPct = limit > 0 ? Math.min(200, pct) : 0;
    const cls = limit === 0 ? 'ok' : (ratio < 0.8 ? 'ok' : (ratio < 1 ? 'warn' : 'bad'));
    const wrap = document.createElement('div'); wrap.className = 'budget-item';
    wrap.innerHTML = `
      <strong>${escapeHtml(sub)}</strong>
      <span class="pill">Ø®Ø±Ø¬â€ŒØ´Ø¯Ù‡: ${fmt(spent)} ØªÙˆÙ…Ø§Ù† / Ø¨ÙˆØ¯Ø¬Ù‡: ${fmt(limit)} ØªÙˆÙ…Ø§Ù† â€” ${pct}%</span>
      ${ratio >= 1 ? `<span class="pill danger">Ø¨ÛŒØ´â€ŒÙ…ØµØ±Ù: ${fmt(spent - limit)} ØªÙˆÙ…Ø§Ù†</span>` : `<span class="pill">Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${fmt(Math.max(0, limit - spent))} ØªÙˆÙ…Ø§Ù†</span>`}
      <div class="progress ${cls}"><span style="width:${widthPct}%"></span></div>
      <div class="row">
        <button class="btn-ghost" data-edit title="ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨ÙˆØ¯Ø¬Ù‡">ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="btn-ghost danger" data-del title="Ø­Ø°Ù Ø¨ÙˆØ¯Ø¬Ù‡">Ø­Ø°Ù</button>
      </div>`;
    wrap.querySelector('[data-del]').onclick = () => {
      delete map[sub]; save(); renderBudgets();
    };
    wrap.querySelector('[data-edit]').onclick = () => {
      const val = prompt('Ø¨ÙˆØ¯Ø¬Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Â«' + sub + 'Â» (ØªÙˆÙ…Ø§Ù†):', limit);
      if (val === null) return;
      const num = Number(val);
      if (isNaN(num) || num < 0) { alert('Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
      map[sub] = num; save(); renderBudgets();
    };
    els.budgetList.appendChild(wrap);

    // Collect alert when reaching >=80% and <100% (warning) or >=100% (critical)
    if (limit > 0 && ratio >= 0.8) {
      budgetAlerts.push({ sub, limit, spent, ratio });
    }
  });

  // If there are budget alerts, create notifications
  if (budgetAlerts.length) {
    budgetAlerts.forEach(b => {
      const type = b.ratio >= 1 ? 'bad' : 'warn';
      const pct = Math.round(b.ratio * 100);
      pushNotification({
        id: 'budget_' + b.sub + '_' + monthKey(),
        title: `Ù‡Ø´Ø¯Ø§Ø± Ø¨ÙˆØ¯Ø¬Ù‡: ${escapeHtml(b.sub)}`,
        text: `Ù‡Ø²ÛŒÙ†Ù‡Ù” "${escapeHtml(b.sub)}" Ø¨Ù‡ ${pct}% Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡Ù” ${fmt(b.limit)} Ø±Ø³ÛŒØ¯Ù‡ â€” Ø®Ø±Ø¬â€ŒØ´Ø¯Ù‡ ${fmt(b.spent)} ØªÙˆÙ…Ø§Ù†.`,
        level: type
      });
    });
  }

  // render notifications in panel after budgets are processed
  renderNotificationsPanel();
}

// ======== Notifications (recurring reminders + budget warnings) ========
function getTomorrowStr() {
  const d = new Date();
  d.setDate(d.getDate() + 1);
  return d.toISOString().slice(0, 10);
}

function buildRecurringReminders() {
  const tomorrow = getTomorrowStr();
  const reminders = [];
  state.recurring.forEach(rc => {
    if (rc.active === false) return;
    let nextDue = rc.lastApplied || rc.startDate;
    if (!nextDue) return;
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ú¯Ø± Ù…ÙˆØ¹Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ (startDate ÛŒØ§ lastApplied) ÙØ±Ø¯Ø§ Ø¨Ø§Ø´Ø¯
    if (nextDue === tomorrow) {
      reminders.push({
        id: 'rc_' + rc.id + '_' + nextDue,
        title: `Ù‡Ø´Ø¯Ø§Ø±: Ù†Ø²Ø¯ÛŒÚ© Ø´Ø¯Ù† Ø¨Ù‡ Ù…ÙˆØ¹Ø¯ ØªØ±Ø§Ú©Ù†Ø´: ${escapeHtml(rc.desc)}`,
        text: `Ù…ÙˆØ¹Ø¯ ØªØ±Ø§Ú©Ù†Ø´ ØªÚ©Ø±Ø§Ø±Ø´ÙˆÙ†Ø¯Ù‡ "${escapeHtml(rc.desc)}" Ø¨Ù‡ Ù…Ø¨Ù„Øº ${fmt(rc.amount)} ØªÙˆÙ…Ø§Ù† (ÙØ±Ø¯Ø§) Ø§Ø³Øª.`,
        level: 'warn'
      });
      return; // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø±Ø±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø§Ú¯Ø± Ù…ÙˆØ¹Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ ÙØ±Ø¯Ø§ Ø¨Ø§Ø´Ø¯
    }
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ ØªØ§ Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø¢ÛŒÙ†Ø¯Ù‡
    const today = todayStr();
    while (nextDue <= today) {
      nextDue = nextDate(nextDue, rc.frequency);
    }
    
    // Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ø¨Ø¹Ø¯ÛŒ ÙØ±Ø¯Ø§ Ø¨Ø§Ø´Ø¯
    if (nextDue === tomorrow) {
      reminders.push({
        id: 'rc_' + rc.id + '_' + nextDue,
        title: `Ù‡Ø´Ø¯Ø§Ø±: Ù†Ø²Ø¯ÛŒÚ© Ø´Ø¯Ù† Ø¨Ù‡ Ù…ÙˆØ¹Ø¯ ØªØ±Ø§Ú©Ù†Ø´: ${escapeHtml(rc.desc)}`,
        text: `Ù…ÙˆØ¹Ø¯ ØªØ±Ø§Ú©Ù†Ø´ ØªÚ©Ø±Ø§Ø±Ø´ÙˆÙ†Ø¯Ù‡ "${escapeHtml(rc.desc)}" Ø¨Ù‡ Ù…Ø¨Ù„Øº ${fmt(rc.amount)} ØªÙˆÙ…Ø§Ù†   (ÙØ±Ø¯Ø§) Ø§Ø³Øª.`,
        level: 'warn'
      });
    }
  });
  return reminders;
}

// pushNotification adds or updates a notification in the ephemeral list then renders panel
function pushNotification(obj) {
  if (!obj || !obj.id) return;
  const exists = currentNotifications.find(n => n.id === obj.id);
  if (exists) return;
  currentNotifications.push(obj);
  renderNotificationsPanel();
  try {
    if ('Notification' in window) {
      if (Notification.permission === 'granted') {
        new Notification(obj.title, { body: obj.text });
      } else if (!inBrowserNotificationPermissionRequested) {
        Notification.requestPermission().then(p => { inBrowserNotificationPermissionRequested = true; if (p === 'granted') { new Notification(obj.title, { body: obj.text }); } });
      }
    }
  } catch(e) {}
}

function renderNotificationsPanel() {
  const n = currentNotifications.length;
  if (n) {
    els.notifCount.style.display = '';
    els.notifCount.textContent = String(n);
  } else {
    els.notifCount.style.display = 'none';
  }
  els.notifList.innerHTML = '';
  currentNotifications.slice().reverse().forEach(nf => {
    const div = document.createElement('div'); div.className = 'nitem ' + (nf.level || 'ok');
    div.innerHTML = `<strong>${escapeHtml(nf.title)}</strong><small>${escapeHtml(nf.text)}</small>`;
    const btn = document.createElement('button'); btn.className = 'btn-ghost'; btn.textContent = 'Ø­Ø°Ù'; btn.style.marginTop='6px';
    btn.onclick = () => { currentNotifications = currentNotifications.filter(x => x !== nf); renderNotificationsPanel(); };
    div.appendChild(btn);
    els.notifList.appendChild(div);
  });
}

// check and build all notifications: recurring reminders + budget alerts
function checkAndBuildNotifications() {
  const reminders = buildRecurringReminders();
  reminders.forEach(r => pushNotification(r));
  // Note: budget alerts are pushed from renderBudgets()
}

// ======== CRUD ========
function resetForm() {
  els.form.reset();
  els.category.value = 'income';
  els.wallet.value = state.wallets[0] || 'Ø§ØµÙ„ÛŒ';
  ensureDateDefault();
  state.editId = null;
  els.submitBtn.textContent = 'Ø§ÙØ²ÙˆØ¯Ù†';
  els.cancelEdit.hidden = true;
}
els.form.addEventListener('submit', e => {
  e.preventDefault();
  const tx = {
    id: state.editId || uid(),
    desc: (els.desc.value || '').trim(),
    amount: Number(els.amount.value),
    category: els.category.value,
    subcat: (els.subcat.value || '').trim(),
    wallet: ensureWallet(els.wallet.value),
    date: els.date.value || todayStr()
  };
  if (!tx.desc || !(tx.amount > 0)) { alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØµØ­ÛŒØ­ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  pushUndo();
  const freq = els.recurring.value;
  if (freq !== 'no' && !state.editId) {
    state.recurring.push({ id: uid(), frequency: freq, startDate: tx.date, lastApplied: tx.date,
      desc: tx.desc, amount: tx.amount, category: tx.category, subcat: tx.subcat, wallet: tx.wallet, active: true });
  }
  if (state.editId) {
    const i = state.tx.findIndex(t => t.id === state.editId);
    if (i > -1) state.tx[i] = tx;
  } else {
    state.tx.push(tx);
  }
  save(); applyAll(); resetForm();
});
function editTx(id) {
  const t = state.tx.find(x => x.id === id); if (!t) return;
  els.desc.value = t.desc; els.amount.value = t.amount; els.category.value = t.category;
  els.subcat.value = t.subcat || ''; els.wallet.value = ensureWallet(t.wallet || 'Ø§ØµÙ„ÛŒ'); els.date.value = t.date;
  state.editId = id; els.submitBtn.textContent = 'Ø«Ø¨Øª ÙˆÛŒØ±Ø§ÛŒØ´'; els.cancelEdit.hidden = false; els.desc.focus();
}
els.cancelEdit.addEventListener('click', resetForm);
function delTx(id) {
  if (!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
  pushUndo();
  const i = state.tx.findIndex(t => t.id === id);
  if (i > -1) state.tx.splice(i, 1);
  save(); applyAll();
}
els.undoBtn.addEventListener('click', undo);

// ======== Filters & Sorting ========
[els.fStart, els.fEnd, els.fCat, els.fWallet, els.fSearch].forEach(el => el.addEventListener('input', applyAll));
$('#resetFilters').addEventListener('click', () => { els.fStart.value = ''; els.fEnd.value = ''; els.fCat.value = ''; els.fWallet.value = ''; els.fSearch.value = ''; applyAll(); });
$$('#table thead th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.sort;
    if (state.sort.key === key) state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
    else { state.sort.key = key; state.sort.dir = 'asc'; }
    applyAll();
  });
});

// ======== Export/Import ========
els.exportJson.addEventListener('click', () => {
  const data = JSON.stringify(state, null, 2);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([data], { type: 'application/json' }));
  a.download = 'pfm_backup.json'; a.click();
});
els.backupBtn.addEventListener('click', () => els.exportJson.click());
els.restoreInput.addEventListener('change', async (e) => {
  const f = e.target.files[0]; if (!f) return;
  try {
    const text = await f.text();
    const obj = JSON.parse(text);
    pushUndo();
    Object.assign(state, { ...state, ...obj });
    save(); applyAll();
  } catch { alert('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª'); }
  e.target.value = '';
});
els.exportExcel.addEventListener('click', () => {
  const list = filtered().map(t => ({
    'ØªØ§Ø±ÛŒØ®': t.date, 'Ø¯Ø³ØªÙ‡': categoryLabel(t.category).replace(/^[ğŸ’°ğŸ›’ğŸ¦]\s*/, ''), 'Ø²ÛŒØ±Ø¯Ø³ØªÙ‡': t.subcat || '',
    'Ø´Ø±Ø­': t.desc || '', 'Ù…Ø¨Ù„Øº(ØªÙˆÙ…Ø§Ù†)': Number(t.amount) || 0, 'Ø­Ø³Ø§Ø¨': t.wallet || 'Ø§ØµÙ„ÛŒ'
  }));
  const ws = XLSX.utils.json_to_sheet(list); const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Transactions'); XLSX.writeFile(wb, 'transactions.xlsx');
});
els.importCsv.addEventListener('change', async (e) => {
  const file = e.target.files[0]; if (!file) return;
  const text = await file.text();
  const rows = text.split(/\r?\n/).filter(Boolean);
  const header = rows.shift().split(',').map(s => s.trim().toLowerCase());
  const idx = x => header.indexOf(x);
  pushUndo();
  for (const r of rows) {
    const c = r.split(',');
    const tx = {
      id: uid(),
      date: c[idx('date')] || todayStr(),
      category: (c[idx('category')] || 'expense').trim(),
      subcat: (c[idx('subcat')] || '').trim(),
      desc: (c[idx('desc')] || '').trim(),
      amount: Number(c[idx('amount')] || 0),
      wallet: ensureWallet((c[idx('wallet')] || 'Ø§ØµÙ„ÛŒ').trim() || 'Ø§ØµÙ„ÛŒ')
    };
    if (tx.amount > 0 && tx.desc) state.tx.push(tx);
  }
  save(); applyAll(); e.target.value = '';
});

// ======== Wallets ========
els.addWallet.addEventListener('click', () => {
  const w = (els.newWallet.value || '').trim(); if (!w) return;
  if (state.wallets.includes(w)) { alert('Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯'); return; }
  pushUndo(); state.wallets.push(w); els.newWallet.value = ''; save(); renderWallets();
});

// ======== Budgets Events ========
els.addBudget.addEventListener('click', (e) => {
  e.preventDefault();
  const sub = (els.budgetSubcat.value || '').trim();
  const amt = Number(els.budgetAmount.value);
  if (!sub || isNaN(amt) || amt < 0) { alert('Ø²ÛŒØ±Ø¯Ø³ØªÙ‡ Ùˆ Ø¨ÙˆØ¯Ø¬Ù‡ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  pushUndo();
  setBudget(sub, amt);
  els.budgetSubcat.value = '';
  els.budgetAmount.value = '';
  els.budgetSubcat.focus();
  applyAll();
});

// ======== Keyboard Shortcuts ========
document.addEventListener('keydown', e => {
  if (e.key === '/' && !['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) { els.fSearch.focus(); e.preventDefault(); }
  if (e.key.toLowerCase() === 'n' && !['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
    e.preventDefault();
    resetForm();
    els.desc.focus();
  }
  if (e.ctrlKey && e.key.toLowerCase() === 's') { e.preventDefault(); els.backupBtn.click(); }
  if (e.ctrlKey && e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); }
  if (e.key.toLowerCase() === 't') { e.preventDefault(); els.darkToggle.click(); }
});

// ======== Notifications panel interactions ========
els.notifBtn.addEventListener('click', () => {
  const panel = els.notifPanel;
  panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'block' : 'none';
  panel.setAttribute('aria-hidden', panel.style.display === 'none' ? 'true' : 'false');
});
els.notifClose.addEventListener('click', () => { els.notifPanel.style.display = 'none'; els.notifPanel.setAttribute('aria-hidden', 'true'); });

// ======== Apply All ========
function renderStats(list) {
  const st = calcStats(list);
  els.balance.textContent = fmt(st.balance);
  els.sumIncome.textContent = fmt(st.income);
  els.sumExpense.textContent = fmt(st.expense);
  els.sumSaving.textContent = fmt(st.saving);
  return st;
}
function applyAll() {
  const list = filtered();
  renderTable(list);
  renderStats(list);
  drawMainChart(list);
  drawMonthChart();
  renderBudgets();
  renderWallets();
  renderRecurring();
  // build notifications (recurring reminders & budget warnings)
  checkAndBuildNotifications();
}

function init() {
  load();
  ensureWallet('Ø§ØµÙ„ÛŒ');
  applyRecurringUpToToday();
  ensureDateDefault();
  applyTheme();
  renderWallets();
  applyAll();
}
init();
</script>

<script>
// === Jalali Helpers ===
const pFmt = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { year: 'numeric', month: 'numeric', day: 'numeric' });
function getJalaliYMD(date) {
  const parts = pFmt.formatToParts(date);
  const get = k => Number(parts.find(x => x.type === k).value);
  return { y: get('year'), m: get('month'), d: get('day') };
}
function jalaliToDate(y, m, d) {
  let lo = new Date('1900-01-01T00:00:00Z').getTime();
  let hi = new Date('2100-12-31T00:00:00Z').getTime();
  while (lo <= hi) {
    const mid = Math.floor((lo + hi) / 2);
    const md = new Date(mid);
    const pj = getJalaliYMD(md);
    if (pj.y === y && pj.m === m && pj.d === d) return new Date(md.getFullYear(), md.getMonth(), md.getDate());
    if (pj.y < y || (pj.y === y && pj.m < m) || (pj.y === y && pj.m === m && pj.d < d)) lo = mid + 86400000; else hi = mid - 86400000;
  }
  return new Date();
}
function isoFromJalali(y, m, d) { return jalaliToDate(y, m, d).toISOString().slice(0, 10); }
function faFromIso(iso) {
  const d = new Date(iso + 'T00:00:00');
  const j = getJalaliYMD(d);
  const pad = n => String(n).padStart(2, '0');
  return `${j.y}/${pad(j.m)}/${pad(j.d)}`;
}
</script>

<script>
// ========== Full Jalali DatePicker ==========
function mountDatepicker(container, inputFa, inputIso, initialIso) {
  const dp = container; let viewDate = initialIso ? new Date(initialIso + 'T00:00:00') : new Date();
  let selIso = initialIso || new Date().toISOString().slice(0, 10);
  function getJalaliYMD(date) {
    const parts = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { year: 'numeric', month: 'numeric', day: 'numeric' }).formatToParts(date);
    const get = k => Number(parts.find(x => x.type === k).value);
    return { y: get('year'), m: get('month'), d: get('day') };
  }
  function jalaliToDate(y, m, d) {
    let lo = new Date('1900-01-01T00:00:00Z').getTime(), hi = new Date('2100-12-31T00:00:00Z').getTime();
    while (lo <= hi) {
      const mid = Math.floor((lo + hi) / 2), md = new Date(mid), pj = getJalaliYMD(md);
      if (pj.y === y && pj.m === m && pj.d === d) return new Date(md.getFullYear(), md.getMonth(), md.getDate());
      if (pj.y < y || (pj.y === y && pj.m < m) || (pj.y === y && pj.m === m && pj.d < d)) lo = mid + 86400000; else hi = mid - 86400000;
    }
    return new Date();
  }
  function isoFromJalali(y, m, d) { return jalaliToDate(y, m, d).toISOString().slice(0, 10); }
  function faFromIso(iso) { const d = new Date(iso + 'T00:00:00'); const j = getJalaliYMD(d); const pad = n => String(n).padStart(2, '0'); return `${j.y}/${pad(j.m)}/${pad(j.d)}`; }
  function daysInJalaliMonth(y, m) { for (let k = 31; k >= 28; k--) { const dt = jalaliToDate(y, m, k); const j = getJalaliYMD(dt); if (j.y === y && j.m === m && j.d === k) return k; } return 30; }
  function render() {
    const j = getJalaliYMD(viewDate); const y = j.y, m = j.m, dim = daysInJalaliMonth(y, m);
    dp.innerHTML = '';
    const header = document.createElement('header');
    const prev = document.createElement('button'); prev.textContent = 'â—€';
    const title = document.createElement('div'); title.textContent = `Ù…Ø§Ù‡ ${m} ${y}`;
    const next = document.createElement('button'); next.textContent = 'â–¶';
    [prev, title, next].forEach(el => header.appendChild(el));
    dp.appendChild(header);
    const wk = ['Ø´', 'ÛŒ', 'Ø¯', 'Ø³', 'Ú†', 'Ù¾', 'Ø¬']; const grid = document.createElement('div'); grid.className = 'grid';
    wk.forEach(w => { const b = document.createElement('button'); b.textContent = w; b.className = 'hd'; grid.appendChild(b); });
    const firstIso = isoFromJalali(y, m, 1); const first = new Date(firstIso + 'T00:00:00').getDay(); const offset = (first + 1) % 7;
    for (let i = 0; i < offset; i++) { const emp = document.createElement('button'); emp.disabled = true; emp.className = 'hd'; emp.textContent = ''; grid.appendChild(emp); }
    for (let d = 1; d <= dim; d++) { const b = document.createElement('button'); b.textContent = String(d); const iso = isoFromJalali(y, m, d); if (iso === selIso) b.classList.add('sel'); b.onclick = () => { selIso = iso; inputIso.value = iso; inputFa.value = faFromIso(iso); hide(); }; grid.appendChild(b); }
    dp.appendChild(grid);
    prev.onclick = () => { const pm = m === 1 ? 12 : m - 1; const py = m === 1 ? y - 1 : y; viewDate = jalaliToDate(py, pm, 1); render(); };
    next.onclick = () => { const nm = m === 12 ? 1 : m + 1; const ny = m === 12 ? y + 1 : y; viewDate = jalaliToDate(ny, nm, 1); render(); };
  }
  function show() { dp.hidden = false; render(); }
  function hide() { dp.hidden = true; }
  inputFa.addEventListener('click', e => { e.stopPropagation(); show(); });
  document.addEventListener('click', e => { if (!dp.contains(e.target) && e.target !== inputFa) hide(); });
  if (initialIso) { inputIso.value = initialIso; inputFa.value = faFromIso(initialIso); } else { const iso = new Date().toISOString().slice(0, 10); inputIso.value = iso; inputFa.value = faFromIso(iso); }
  render();
}
</script>
</body>
</html>
